<!DOCTYPE html>
<html>

<head>
    <script src="javascript/jquery-3.1.1.min.js"></script>
    <script src="/assets/javascripts/jatos.js"></script>
    <link rel="stylesheet" href="bootstrap-3.3.7/css/bootstrap.min.css">
    <link href="static/css/forms.css" rel="stylesheet" type="text/css" media="all">
    <script src="utils/uuid.js"></script>

</head>

<body>
    <div class= "TaskDescription">

        <div>
            ID CODE: <div id="id"></div>
        </div>
        <div id="description_div"></div>
        
        <div id="next_button">...Loading study data</div>
        </div>
        </div>
    </div>
    
    <script>
        function getRandomTaskID(){
            let task_ids = ["TEXTURE", "COLOR", "SHAPE"]
            let v  = Math.floor (Math.random()*3);
            return task_ids[v];
        }
        
        function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;
            
            // While there remain elements to shuffle...
            while (0 !== currentIndex) {
                
                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;
                
                // And swap it with the current element.
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }
            return array;
        }



        function generateTaskSamplesMultiMode( studyData, modes){
            var taskDict = {};
            var samples = {}
            results = {}
            taskDict = {}
            //Practice //
            var i =0;
            var nTasks, nSamplesPerTask, taskModes;
            var actualNumSamples = studyData["n_samples"];

            var shuffleIndexes = [...Array(actualNumSamples)].map((_,i) => i);
            var sampleIndexes = shuffle(shuffleIndexes);

            var totalSamples = 6*3*30*3 +8*30*3 +10*30*3 +15

            while (sampleIndexes.length < totalSamples){
                let s2 =  shuffle(shuffleIndexes.slice());
                sampleIndexes = sampleIndexes.concat(s2);
            }
            console.log("Total study samples : " +totalSamples);
            console.log("Number of samples : " + actualNumSamples );
            console.log(sampleIndexes)

            jatos.studySessionData["num_tasks"] = [];
            jatos.studySessionData["task_modes"] = [];
            jatos.studySessionData["num_phases"] = [];
            jatos.studySessionData["targets"]= [];
            var targets = []

            for (let i in modes){
                let mode = modes[i];
                var taskModes;
                if (i==0){
                    nTasks = [1,6,6,6,8,10];
                    nSamplesPerTask = [15,30,30,30,30,30];
                    // nSamplesPerTask = [2,2,2,2,2,2];
                    // nTasks = [1,1,1,1,1,1];
                    taskModes = ["PRACTICE","BASELINE", "BASELINE", mode, mode, mode+"_RANDOM"];
                }
                else{
                    nTasks = [6,6,6,6,8,10];
                    nSamplesPerTask = [30,30,30,30,30,30];
                    // nSamplesPerTask = [2,2,2,2,2,2];
                    // nTasks = [1,1,1,1,1,1];
                    taskModes = ["BASELINE_RANDOM", "BASELINE", "BASELINE",  mode, mode, mode +"_RANDOM"]
                }
                jatos.studySessionData["num_tasks"].push(nTasks);
                jatos.studySessionData["task_modes"].push(taskModes);

                var nPhases = nTasks.length;
                jatos.studySessionData["num_phases"].push(nPhases);

                taskDict[i]= {}
                results[i]= {}
                sampleIndex =0;
                // Generate sample sets for tasks
                for (var p =0; p<nPhases; p++){
                    taskDict[i][p]={};
                    results[i][p]={};
                    
                    for (var t =0; t<nTasks[p]; t++){
                        var sampleList =[];
                        let temp_target= sampleIndexes[sampleIndex];
                        let temp_index = sampleIndex;
                        
                        //Make sure we haven't already ahd the same target
                        while (targets.includes(temp_target)){
                            temp_index ++;
                            temp_target= sampleIndexes[temp_index]
                        }

                        //If we had to search for a new target, perform the swap
                        if (temp_index!=sampleIndexes){
                            let b = sampleIndexes[temp_index];
                            sampleIndexes[temp_index]= sampleIndexes[sampleIndex];
                            sampleIndexes[sampleIndex]=b;
                            console.log("had to swap samples")
                        }
                        targets.push(sampleIndexes[sampleIndex])
                        //Fill the task
                        for (var s =0; s<nSamplesPerTask[p]; s++){
                            sampleList.push(sampleIndexes[sampleIndex]);
                            let sample = studyData.samples[sampleIndexes[sampleIndex]];
                            samples[sampleIndexes[sampleIndex]] =  sample;
                            sampleIndex ++;
                        }

                        taskDict[i][p][t]= sampleList;
                        results[i][p][t]={};
                    } 
                } 

            }                      
            jatos.studySessionData["targets"]= targets;
            jatos.studySessionData["results"] = results;
            jatos.studySessionData["task_dict"] =taskDict;
            console.log(targets);

            console.log(samples);
            console.log(taskDict);
            return  samples;
        }

        function sessionSuccess(){
            console.log("Succesfully sent session data");
            console.log(jatos.studySessionData);
        }
        
        function sessionFailure(){
            console.log("Failed to send session data");
        }
        
        jatos.onLoad(function () {
            var lang = "default";

            if (jatos.studySessionData.language){
                lang = jatos.studySessionData.language
            }

            let loading_string = "...Loading study data"
            if (lang =="fr"){
                loading_string = "...Chargement des données de l'étude"
            }
            $("#next_button").html(loading_string);
            //Load the correct description and display it
            $.ajax({
                    url:"static/html/task_descriptions.html",
                    type:'GET',
                    success: function(data) {
                        console.log("Mode order : " +jatos.studySessionData["mode_order"])
                        console.log("Language: "+lang)
                        var description = $('<div>').append(data).find('#task_description').find(`#${lang}`);
                        let title = $('<div>').append(data).find('#title').find(`#${lang}`)
                        $('#description_div').html( description );


                        if ("uuid" in jatos.urlQueryParameters){
                            console.log("Assigning previous uuid:" + jatos.urlQueryParameters["uuid"])
                            jatos.studySessionData["uuid"] = jatos.urlQueryParameters["uuid"];
                            jatos.studySessionData["phase_index"] = 3;
                        }
                        else{
                            jatos.studySessionData["uuid"] = uuid4();
                        }
                        console.log("Participant ID: "+jatos.studySessionData["uuid"])

                        $("#id").text(jatos.studySessionData["uuid"])
                    }
                });

            var json= $.getJSON("static/data/study_data.json", function(studyData){         
                let samples = generateTaskSamplesMultiMode(studyData,jatos.studySessionData["mode_order"] );
                jatos.studySessionData["task_index"] = jatos.studySessionData["mode_order"][0];

                jatos.studySessionData["task_index"] = 0;
                jatos.studySessionData["phase_index"] = 0;
                jatos.studySessionData["mode_index"] = 0;
                jatos.studySessionData["num_practices"] = 1;
                jatos.studySessionData["volume"] = 0.5;



                let continueString ="Continue" 
                if (lang =="fr") {continueString= "Continuer"};

                $("#next_button").html(`<button id="continue" type="button" class="btn btn-success">${continueString}</button>`)
                $("#continue").click(function(){
                    sessionStorage.removeItem("sample_data");
                    jatos.submitResultData(JSON.stringify(jatos.studySessionData));
                    sessionStorage.setItem("sample_data", JSON.stringify(samples))
                    jatos.startNextComponent()
                    });
                });                
                });
        </script>
    </body>
</html>